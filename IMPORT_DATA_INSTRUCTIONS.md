# Инструкция по импорту данных в Agent-Trade

## Проблема и решение

### Проблема
При попытке импорта данных через фронтенд возникала ошибка 403 "inactive user".

### Причина
1. **Неактивный пользователь**: Пользователь не был активен в системе
2. **Недостаточные права**: Endpoint импорта данных требует права администратора
3. **Неправильная обработка CSV**: Функция импорта не поддерживала колонки `max`/`min` вместо `high`/`low`

### Решение
1. ✅ **Создан активный администратор** с правами admin
2. ✅ **Исправлена функция импорта данных** для поддержки разных форматов колонок
3. ✅ **Добавлена поддержка определения монеты** из имени файла
4. ✅ **Исправлена валидация колонок** в endpoint импорта

## Как использовать импорт данных

### 1. Авторизация
Войдите в систему как администратор:
- **Email**: admin@agent-trade.com
- **Пароль**: admin123

### 2. Импорт через фронтенд
1. Откройте страницу профиля (`/profile_page`)
2. Перейдите на вкладку "ML Studio"
3. Выберите "Data Manager"
4. Нажмите "Choose File" и выберите CSV файл
5. Выберите timeframe (например, "5m")
6. Нажмите "Import"

### 3. Поддерживаемые форматы файлов

#### CSV файл должен содержать следующие колонки:
- `datetime` - дата и время (обязательно)
- `open` - цена открытия (обязательно)
- `close` - цена закрытия (обязательно)
- `volume` - объем торгов (обязательно)
- `high` или `max` - максимальная цена (обязательно)
- `low` или `min` - минимальная цена (обязательно)

#### Пример CSV файла:
```csv
datetime,open,max,min,close,volume
2025-05-31 18:00:00,2542.42,2543.95,2539.82,2543.94,307810.012217333
2025-05-31 17:55:00,2541.68,2543.88,2539.43,2542.42,434759.000933641
```

### 4. Определение монеты
Имя монеты определяется автоматически из имени файла:
- `ETH_5m.csv` → монета "ETH"
- `BTC_1h.csv` → монета "BTC"
- Если имя монеты не может быть определено, используется "ETH" по умолчанию

### 5. API Endpoints

#### Импорт данных
```http
POST /api_db_agent/data/import
Authorization: Bearer <token>
Content-Type: multipart/form-data

file: <csv_file>
timeframe: 5m
```

#### Получение статистики
```http
GET /api_db_agent/data/stats?timeframe=5m&coins=1,2&start_date=2025-05-01&end_date=2025-05-31
Authorization: Bearer <token>
```

#### Экспорт данных
```http
GET /api_db_agent/data/export?coins=1,2&timeframe=5m&start_date=2025-05-01&end_date=2025-05-31&format=csv
Authorization: Bearer <token>
```

## Тестирование

Для тестирования импорта данных используйте скрипт:
```bash
python3 test_import_frontend.py
```

## Учетные данные администратора

- **Логин**: admin
- **Email**: admin@agent-trade.com
- **Пароль**: admin123
- **Роль**: admin
- **Статус**: активен

## Возможные проблемы

### 1. Ошибка 403 "inactive user"
**Решение**: Убедитесь, что вы вошли как администратор с активным статусом.

### 2. Ошибка валидации колонок
**Решение**: Проверьте, что CSV файл содержит все обязательные колонки.

### 3. Дубликаты записей
**Решение**: Система автоматически пропускает дубликаты. Это нормальное поведение.

### 4. Ошибка подключения к базе данных
**Решение**: Убедитесь, что все Docker контейнеры запущены:
```bash
docker ps
```

## Логи и отладка

Для просмотра логов backend:
```bash
docker logs agent-trade-backend-1
```

Для просмотра логов frontend:
```bash
docker logs agent-trade-frontend-1
```
